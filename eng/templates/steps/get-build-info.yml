parameters:
- name: dotnetStagingPipelineResource
  type: string
- name: releaseBranchName
  type: string
- name: getAssociatedPipelineRuns
  type: boolean
  default: false
- name: useSpecificPipelineRunIDs
  type: boolean
  default: false
- name: dotnetInstallerOfficialRunID
  type: string
  default: ''
- name: dotnetInstallerTarballBuildRunID
  type: string
  default: ''
- name: dotnetDotnetRunID
  type: string
  default: ''
- name: verifyBuildSuccess
  type: boolean
- name: isDryRun
  type: boolean
  default: false

steps:
- download: ${{ parameters.dotnetStagingPipelineResource }}
  artifact: manifests
  patterns: manifest.json
  displayName: Download Release Manifest

- download: ${{ parameters.dotnetStagingPipelineResource }}
  artifact: drop
  patterns: config.json
  displayName: Download Release Config

- script: |
    set -euo pipefail

    manifest_path=$(PIPELINE.WORKSPACE)/dotnet-staging-pipeline-resource/manifests/manifest.json
    config_path=$(PIPELINE.WORKSPACE)/dotnet-staging-pipeline-resource/drop/config.json

    runtime_version="$(jq -r '.Runtime' "$config_path")"
    release_channel="$(jq -r '.Channel' "$config_path")"

    # Source-build only supports the lowest available feature band.
    # Sort the SDK releases by number and pick the lowest value.
    # We also need to remove the preview label from the version
    sdk_version="$(jq -r '.Sdks | sort_by(. | split(".") | map(sub("-[a-z0-9]+"; "")) | map(tonumber)) | .[0]' $config_path)"

    branch_name="${{ parameters.releaseBranchName }}"
    if [ -z "$branch_name" ]; then
      # For non-preview releases, the branch name can be determined from the SDK version
      # Replace the last two characters in sdk_version with xx
      branch_version=$(echo $sdk_version | sed 's/..$/xx/')
      branch_name="refs/heads/internal/release/${branch_version}"
    fi

    if [[ ! "$branch_name" =~ ^refs/heads/ ]]; then
      branch_name="refs/heads/$branch_name"
    fi

    commit=$(jq -r --arg BRANCH "$branch_name" '.builds[] | select(.repo == "https://dev.azure.com/dnceng/internal/_git/dotnet-installer" or .repo == "https://github.com/dotnet/installer") | select(.branch == $BRANCH) | .commit' $manifest_path)

    if [[ ! $commit ]]; then
      echo "##vso[task.logissue type=error]Installer build on a commit for branch $branch_name not found. Exiting..."
      exit 1
    fi

    echo "Release channel: ${release_channel}"
    echo "Runtime version: ${runtime_version}"
    echo "SDK version: ${sdk_version}"
    echo "Installer commit: ${commit}"

    echo "##vso[task.setvariable variable=SdkVersion;isOutput=true]${sdk_version}"
    echo "##vso[task.setvariable variable=RuntimeVersion;isOutput=true]${runtime_version}"
    echo "##vso[task.setvariable variable=ReleaseChannel;isOutput=true]${release_channel}"
    echo "##vso[task.setvariable variable=InstallerCommit;isOutput=true]${commit}"

    build_name="$(resources.pipeline.dotnet-staging-pipeline-resource.runName)"
    if [ ${{ parameters.isDryRun }} = True ]; then
      build_name="${build_name}-dryrun"
    fi

    original_build_name='$(Build.BuildNumber)'
    revision="${original_build_name:9}"

    echo "##vso[build.updatebuildnumber]${build_name}-${revision}"
  name: ReadReleaseInfo
  displayName: Read Release Info

- ${{ if eq(parameters.getAssociatedPipelineRuns, true) }}:
  - ${{ if eq(parameters.useSpecificPipelineRunIDs, false) }}:
    - script: |
        set -euo pipefail
        source eng/get-build-info.sh

        if [[ "$(ReadReleaseInfo.ReleaseChannel)" == "8.0" ]]; then
            get_build_info \
              "$(AZDO_ORG)" \
              "$(AZDO_PROJECT)" \
              "$(DOTNET_DOTNET_CI_PIPELINE_ID)" \
              dotnet-dotnet \
              DotnetDotnetRunId \
              DotnetDotnetCommit \
              "${{ parameters.verifyBuildSuccess }}" \
              tag \
              "installer-$(ReadReleaseInfo.InstallerCommit)"
        else
            get_build_info \
              "$(AZDO_ORG)" \
              "$(AZDO_PROJECT)" \
              "$(INSTALLER_OFFICIAL_CI_PIPELINE_ID)" \
              dotnet-installer-official-ci \
              InstallerOfficialRunId \
              InstallerCommit \
              "${{ parameters.verifyBuildSuccess }}" \
              sourceVersion \
              "$(ReadReleaseInfo.InstallerCommit)"

            get_build_info \
              "$(AZDO_ORG)" \
              "$(AZDO_PROJECT)" \
              "$(INSTALLER_TARBALL_BUILD_CI_PIPELINE_ID)" \
              dotnet-installer-source-build-tarball-build \
              InstallerTarballBuildRunId \
              InstallerCommit \
              "${{ parameters.verifyBuildSuccess }}" \
              sourceVersion \
              "$(ReadReleaseInfo.InstallerCommit)"
        fi
      name: AssociatedPipelineRuns
      displayName: Get Associated Pipeline Run IDs
      env:
        AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)

  - ${{ else }}:
    - script: |
        set -euo pipefail
        source eng/get-build-info.sh

        if [[ "$(ReadReleaseInfo.ReleaseChannel)" == "8.0" ]]; then
          print_build_info dotnet-dotnet DotnetDotnetRunId DotnetDotnetCommit "$(dotnetDotnetRunID)" "See the build info"
        else
          print_build_info dotnet-installer-official-ci InstallerOfficialRunId InstallerCommit "$(dotnetInstallerOfficialRunID)" "$(ReadReleaseInfo.InstallerCommit)"
          print_build_info dotnet-installer-source-build-tarball-build InstallerTarballBuildRunId InstallerCommit "$(dotnetInstallerTarballBuildRunID)" "N/A"
        fi
      name: AssociatedPipelineRuns
      displayName: Set Associated Pipeline Run IDs