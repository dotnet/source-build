parameters:
  job: null
  matrix:
    Production: {}
  pool:
    name: Hosted Ubuntu 1604
  imageName: null
  reportPrebuiltLeaks: false
  dependsOn: ''
  generatePrebuiltBurndown: false
  runUnitTests: false
  dockerNetwork: ''

jobs:
- job: ${{ parameters.job }}
  dependsOn: ${{ parameters.dependsOn }}
  strategy:
    matrix: ${{ parameters.matrix }}
  pool: ${{ parameters.pool }}
  timeoutInMinutes: 270
  variables:
    # Prefix to distinguish artifacts from different legs.
    artifactName: ${{ format('{0} $(type)', parameters.job) }}
    # Use ":z" to set selinux flag for sharing in build-owned root dir. https://docs.docker.com/storage/bind-mounts/#configure-the-selinux-label
    docker.agentSrc.map: -v $(Build.SourcesDirectory):/agentSrc:z
    docker.agentSrc.work: -w /agentSrc
    docker.drop.map: -v $(dropDirectory):/drop:z
    docker.logs.map: -v $(dropDirectory)/logs:/logs:z
    docker.root.map: -v $(rootDirectory):/root:z
    docker.run: docker run --rm
    docker.src.map: -v $(rootDirectory)/sb/source-build:/src:z
    docker.src.work: -w /src
    docker.tb.map: -v $(rootDirectory)/sb/tarball:/tb:z
    docker.tb.work: -w /tb
    docker.bst.map: -v $(System.ArtifactsDirectory)/boostrap_root:/bst:z
    docker.bst.work: -w /bst
    dropDirectory: $(stagingDirectory)/drop
    imageName: ${{ parameters.imageName }}
    reportPrebuiltLeaks: ${{ parameters.reportPrebuiltLeaks }}
    generatePrebuiltBurndown: ${{ parameters.generatePrebuiltBurndown }}
    rootDirectory: $(Build.SourcesDirectory)/..
    stagingDirectory: $(rootDirectory)/sb/staging
    tarballName: tarball_$(Build.BuildId)
    SOURCE_BUILD_SKIP_SUBMODULE_CHECK: true
    # Default type, can be overridden by matrix legs.
    type: Production

  steps:
  # - template: ../steps/cleanup-unneeded-files.yml
  - template: ../steps/docker-cleanup-linux.yml
  - template: ../steps/calculate-config-flags.yml

  # Create working directory and copy source into it.
  - script: |
      set -ex
      df -h
      $(docker.run) $(docker.root.map) $(docker.agentSrc.map) $(docker.agentSrc.work) $(imageName) bash -c '
        rm -rf /root/sb/
        mkdir -p /root/sb/tarball'
      du -h $(rootDirectory) | sort -h | tail -n 50
    displayName: Clean sb directory

  - task: DownloadBuildArtifacts@0
    displayName: Download CentOS artifacts
    inputs:
      buildType: 'specific'
      project: 'internal'
      pipeline: 'source-build-rolling-CI'
      buildVersionToDownload: 'specific'
      buildId: '441879'
      artifactName: 'Tarball centos71 Offline'
      downloadPath: '$(System.ArtifactsDirectory)/boostrap_root'

  - script: |
      set -ex
      df -h
      $(docker.run) $(docker.bst.map) $(docker.bst.work) $(imageName) bash -c '
      git clone https://github.com/dotnet/source-build-reference-packages'
      du -h $(rootDirectory) | sort -h | tail -n 50
    displayName: clone source-build-reference-packages
    condition: always()
    continueOnError: true
  
  - script: |
      set -ex 
      df -h 
      $(docker.run) --network=none $(docker.bst.map) $(docker.bst.work) $(imageName) bash -c '
      ls /bst
      mkdir -p /bst/sb/tarball
      mkdir -p /bst/bootstrap_dir
      tar -xvf "/bst/Tarball centos71 Offline/$(tarballName).tar.gz" -C /bst/sb/tarball --no-same-owner --strip-components=1
      ls /bst/sb/tarball
      ./bst/sb/tarball/$(tarballName)/support/tarball/tool-bootstrapping/bootstrap.sh /bst/bootstrap_dir /bst/sb/tarball /bst/source-build-reference-packages'
      du -h $(rootDirectory) | sort -h | tail -n 50
    displayName: Unpack the tarball and Run Bootstrapping
    condition: always()
    continueOnError: false

  # Clean up (very large) working directory. root owner makes it difficult for others to remove.
  - script: $(docker.run) $(docker.root.map) $(imageName) bash -c 'rm -rf /root/tb'
    displayName: Clean tb directory
    condition: always()
    continueOnError: true

  - template: ../steps/docker-cleanup-linux.yml

  - script: df -h
    displayName: Check space (df -h)
    condition: always()
    continueOnError: true
