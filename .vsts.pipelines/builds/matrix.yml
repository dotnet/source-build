# Matrix build types:
#   Production: Only runs the build, not a tarball build. Called "production" because it's the part
#     used to produce tarballs. Some platforms might not be capable of producing a tarball yet: we
#     still call this type of build "production" for consistency.
#   Online: The leg produces a tarball then builds it while connected to the internet.
#   Offline: The leg produces a tarball then builds it offline. Network disconnected using Docker.

parameters:
  windowsPoolName: NetCorePublic-Pool
  windowsQueueName: buildpool.windows.10.amd64.vs2017.open

jobs:
- template: ../jobs/ci-linux.yml
  parameters:
    job: centos71
    imageName: mcr.microsoft.com/dotnet-buildtools/prereqs:centos-7-359e48e-20200313130914
# Temporarily disable reporting on prebuilt leaks until entire product builds.
# See https://github.com/dotnet/source-build/issues/1548
    reportPrebuiltLeaks: false
    matrix:
# Temporarily disable unit tests until entire product builds.
# See https://github.com/dotnet/source-build/issues/1549
      Production: { generatePrebuiltBurndown: true, runUnitTests: false }
      Online: { type: Online }
      Offline: { type: Offline }

# Temporarily disable bootstrap build until entire product builds.
# See https://github.com/dotnet/source-build/issues/1550
#- template: ../jobs/ci-linux_bootstrap.yml
#  parameters:
#    job: centos71_BootStrap
#    dependsOn: centos71
#    imageName: mcr.microsoft.com/dotnet-buildtools/prereqs:centos-7-359e48e-20200313130914
#    matrix:
#      Offline: { type: Offline}

- template: ../jobs/ci-linux.yml
  parameters:
    job: centos8
    imageName: mcr.microsoft.com/dotnet-buildtools/prereqs:centos-8-source-build-20200402192642-9e679d4
    reportPrebuiltLeaks: false
    systemLibunwind: false
    matrix:
      Production: {}
      Online: { type: Online }
      Offline: { type: Offline }

- template: ../jobs/ci-linux.yml
  parameters:
    job: debian9
    imageName: mcr.microsoft.com/dotnet-buildtools/prereqs:debian-stretch-source-build-20200331133109-ed32d26
    matrix:
      Production: {}
      Online: { type: Online }

- template: ../jobs/ci-linux.yml
  parameters:
    job: fedora30
    imageName: mcr.microsoft.com/dotnet-buildtools/prereqs:fedora-30-bfcd90a-20200324132732
    matrix:
      Production: {}
      Online: { type: Online }
      Offline: { type: Offline }
      Offline Portable: { type: Offline Portable }

- template: ../jobs/ci-linux.yml
  parameters:
    job: fedora31
    imageName: mcr.microsoft.com/dotnet-buildtools/prereqs:fedora-31-02f7c7e-20200324132728
    matrix:
      Production: {}
      Online: { type: Online }
      Offline: { type: Offline }

- template: ../jobs/ci-linux.yml
  parameters:
    job: ubuntu1804
    imageName: mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-18.04-source-build-20200401093015-ed32d26

- template: ../jobs/ci-local.yml
  parameters:
    job: osx
    pool:
      name: Hosted macOS
    scriptPrefix: ./
    scriptSuffix: .sh
    setupMac: true
