From 0cc84816123aa8a2cd0ea2d65b4d3be5028b77e0 Mon Sep 17 00:00:00 2001
From: Davis Goodin <dagood@microsoft.com>
Date: Fri, 13 Nov 2020 13:16:19 -0600
Subject: [PATCH] Override Microsoft.CodeAnalysis.CSharp pkg deps

Microsoft.CodeAnalysis.CSharp brings in System.Collections.Immutable and
System.Reflection.Metadata dependencies with prebuilt versions. We can
override them to the version that we built.

dotnet/arcade already defines SystemCollectionsImmutableVersion and
SystemReflectionMetadataVersion, and it seems safe to use their values.

See https://github.com/dotnet/source-build/pull/1881
---
 .../Microsoft.DotNet.CodeAnalysis.csproj               | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/Microsoft.DotNet.CodeAnalysis/Microsoft.DotNet.CodeAnalysis.csproj b/src/Microsoft.DotNet.CodeAnalysis/Microsoft.DotNet.CodeAnalysis.csproj
index 5cdfd539..d1ac5ccb 100644
--- a/src/Microsoft.DotNet.CodeAnalysis/Microsoft.DotNet.CodeAnalysis.csproj
+++ b/src/Microsoft.DotNet.CodeAnalysis/Microsoft.DotNet.CodeAnalysis.csproj
@@ -12,6 +12,16 @@
     <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="$(MicrosoftCodeAnalysisCSharpVersion)" ExcludeAssets="analyzers" />
   </ItemGroup>
 
+  <!--
+    In the source-build tarball build, Microsoft.CodeAnalysis.CSharp has dependencies on old
+    versions of these packages due to repo build order. Override to lift them to the versions passed
+    in via DotNetPackageVersionPropsPath.
+  -->
+  <ItemGroup Condition="'$(DotNetBuildFromSource)' == 'true'">
+    <PackageReference Include="System.Collections.Immutable" Version="$(SystemCollectionsImmutableVersion)" />
+    <PackageReference Include="System.Reflection.Metadata" Version="$(SystemReflectionMetadataVersion)" />
+  </ItemGroup>
+
   <ItemGroup>
     <Content Include="build/*.*" PackagePath="build" />
     <Content Include="content/*.*" PackagePath="content" />
-- 
2.25.2

