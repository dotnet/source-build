From 20eff0e62e16c49d0b02e861f2cc553d7de66061 Mon Sep 17 00:00:00 2001
From: Davis Goodin <dagood@microsoft.com>
Date: Mon, 28 Dec 2020 11:20:26 -0600
Subject: [PATCH] Reference latest when running in build

---
 src/Directory.Build.targets                   | 35 +++++++++++++++++++
 ...GenerateDocumentationAndConfigFiles.csproj |  3 ++
 2 files changed, 38 insertions(+)

diff --git a/src/Directory.Build.targets b/src/Directory.Build.targets
index 46e0c6d77..55ec2b895 100644
--- a/src/Directory.Build.targets
+++ b/src/Directory.Build.targets
@@ -11,6 +11,41 @@
     <EmbeddedResource Update="**\*.resx" GenerateSource="true" />
   </ItemGroup>
 
+  <!--
+    If this project executes during the build (a tool project, rather than a project that compiles
+    against reference assemblies for maximum compatibility), use the latest version of every package
+    rather than whatever the transitive closure happens to include. In source-build, if we use an
+    old reference-only package, it will fail to execute becuase methods are missing implementations.
+  -->
+  <ItemGroup Condition="'$(ExecutesDuringBuild)' == 'true'">
+    <ExecuteDuringBuildLatestPackageId Include="Microsoft.Bcl.AsyncInterfaces" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Collections.Immutable" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Composition" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Composition.AttributedModel" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Composition.Convention" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Composition.Hosting" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Composition.Runtime" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Composition.TypedParts" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Reflection.Metadata" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Runtime.CompilerServices.Unsafe" />
+    <ExecuteDuringBuildLatestPackageId Include="System.Text.Encoding.CodePages" />
+
+    <!-- Find the name used by the PackageVersions.props infrastructure. -->
+    <ExecuteDuringBuildLatestPackageId
+      Update="@(ExecuteDuringBuildLatestPackageId)"
+      VersionPropertyName="$([System.String]::new('%(Identity)').Replace('.',''))Version" />
+
+    <!--
+      If the package version property is set (we are running in source-build or have the version in
+      eng/Versions.props), use it.
+    -->
+    <ExecuteDuringBuildLatestPackageId
+      Update="@(ExecuteDuringBuildLatestPackageId)"
+      Version="$(%(VersionPropertyName))" />
+
+    <PackageReference Include="@(ExecuteDuringBuildLatestPackageId->HasMetadata('Version'))" />
+  </ItemGroup>
+
   <ItemGroup>
     <!-- Workaround for https://github.com/dotnet/project-system/issues/2374 -->
     <UpToDateCheckInput Include="$(CodeAnalysisRuleSet)" Condition="'$(CodeAnalysisRuleSet)' != ''" />
diff --git a/src/Tools/GenerateDocumentationAndConfigFiles/GenerateDocumentationAndConfigFiles.csproj b/src/Tools/GenerateDocumentationAndConfigFiles/GenerateDocumentationAndConfigFiles.csproj
index 3a72b78f4..1097c909b 100644
--- a/src/Tools/GenerateDocumentationAndConfigFiles/GenerateDocumentationAndConfigFiles.csproj
+++ b/src/Tools/GenerateDocumentationAndConfigFiles/GenerateDocumentationAndConfigFiles.csproj
@@ -8,6 +8,9 @@
     <AutoGenerateBindingRedirects>true</AutoGenerateBindingRedirects>
     <MicrosoftCodeAnalysisVersion>$(MicrosoftCodeAnalysisForRoslynDiagnosticsAnalyzersVersion)</MicrosoftCodeAnalysisVersion>
   </PropertyGroup>
+  <PropertyGroup>
+    <ExecutesDuringBuild>true</ExecutesDuringBuild>
+  </PropertyGroup>
   <ItemGroup>
     <Compile Include="..\..\Microsoft.CodeAnalysis.Analyzers\Core\MetaAnalyzers\ReleaseTrackingHelper.cs" Link="ReleaseTrackingHelper.cs" />
     <Compile Include="..\..\Utilities\Compiler\Debug.cs" Link="Debug.cs" />
-- 
2.21.3

