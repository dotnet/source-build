<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="$(TasksBinDir)Microsoft.DotNet.SourceBuild.Tasks.dll" TaskName="DiscoverProjectsForTFMs" />
  <UsingTask AssemblyFile="$(TasksBinDir)Microsoft.DotNet.SourceBuild.Tasks.dll" TaskName="AddPublicSignToProjectJson" />

  <Target Name="UpdateProjectJsons" BeforeTargets="Sync">
    <DiscoverProjectsForTFMs RootDirectory="$(NuGetCoreSourceDirectory)"
                             TFMs="@(BuildTFMs)">
      <Output TaskParameter="DiscoveredProjects"
              ItemName="NugetClientProjects" />
    </DiscoverProjectsForTFMs>

    <AddPublicSignToProjectJson ProjectJsonFiles="@(NugetClientProjects)"
                                KeyFilePath="$(NuGetKeyFilePath)" />
    <PropertyGroup>
       <SupportedProjects>@(NugetClientProjects)</SupportedProjects>
       <SyncCommand>$(SyncCommand) $(SupportedProjects.Replace(';', ' '))</SyncCommand>
    </PropertyGroup>
  </Target>
  
  <Target Name="Build">
    <MSBuild Projects="$(MSBuildProjectFullPath)"
             Targets="BuildProjectsForTFM"
             Properties="BuildTFM=%(BuildTFMs.Identity)" />
             
    <DiscoverProjectsForTFMs RootDirectory="$(NuGetCoreSourceDirectory)"
                             TFMs="@(BuildTFMs)">
      <Output TaskParameter="DiscoveredProjects"
              ItemName="NugetClientProjects" />
    </DiscoverProjectsForTFMs>

    <Exec Command="$(OverridesForCommands) $(DotNetCommand) pack --no-build -c $(Configuration) -o $(PackagesOutput) -s %(NugetClientProjects.Identity) --version-suffix $(NuGetClientVersionSuffix)" />
    <!-- Ensure this missing dependency gets built on linux -->
    <Exec Condition="'$(TargetOS)'!='Windows_NT'" Command="$(OverridesForCommands) $(ToolsDir)/dotnetcli/dotnet pack --no-build -c $(Configuration) -o $(PackagesOutput) -s $(ProjectDirectory)/src/NuGet.Core/NuGet.Build.Tasks.Pack.Library/NuGet.Build.Tasks.Pack.csproj /p:VersionSuffix=$(NuGetClientVersionSuffix)" />
  </Target>

  <Target Name="BuildProjectsForTFM">
    <Message Text="Building projects for $(BuildTFM)" />

    <DiscoverProjectsForTFMs RootDirectory="$(NuGetCoreSourceDirectory)"
                             TFMs="$(BuildTFM)">
      <Output TaskParameter="DiscoveredProjects"
              ItemName="Projects" />
    </DiscoverProjectsForTFMs>

    <Exec Command="$(OverridesForCommands) $(DotNetCommand) build %(Projects.Identity) -c $(Configuration) -f $(BuildTFM)" Condition="'@(Projects)' != ''"/>
  </Target>

</Project>
